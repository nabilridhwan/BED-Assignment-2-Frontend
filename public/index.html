<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Home</title>
  <link rel="icon" href="img/Fevicon.png" type="image/png">
  <link rel="stylesheet" href="vendors/bootstrap/bootstrap.min.css">
  <link rel="stylesheet" href="vendors/fontawesome/css/all.min.css">
  <link rel="stylesheet" href="vendors/themify-icons/themify-icons.css">
  <link rel="stylesheet" href="vendors/nice-select/nice-select.css">
  <link rel="stylesheet" href="vendors/owl-carousel/owl.theme.default.min.css">
  <link rel="stylesheet" href="vendors/owl-carousel/owl.carousel.min.css">

  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <!--================ Start Header Menu Area =================-->
  <header class="header_area">

    <div class="main_menu">
      <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
          <a class="navbar-brand logo_h" href="index.html"><img src="img/logo.png" width="72" alt=""></a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="collapse navbar-collapse offset" id="navbarSupportedContent">

            <ul class="nav navbar-nav menu_nav ml-auto mr-auto">


              <li class="nav-item active"><a class="nav-link" href="index.html">Home</a></li>
              <li class="nav-item"><a class="nav-link" href="/products">Products</a></li>
              <li class="nav-item"><a class="nav-link" href="/categories">Categories</a></li>

              <li class="nav-item submenu dropdown">
                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                  aria-expanded="false">Admin</a>

                <ul class="dropdown-menu admin-only">
                  <li class="nav-item admin-only"><a class="nav-link" href="/addcategory">Add Category</a></li>
                  <li class="nav-item admin-only"><a class="nav-link" href="/addproduct">Add Product</a></li>
                  <li class="nav-item admin-only"><a class="nav-link" href="/adddiscount">Add Discounts</a></li>
                </ul>

              </li>


            </ul>

            <ul class="nav-shop">
              <li class="nav-item"><button><i class="ti-shopping-cart"></i><span
                    class="nav-shop__circle">3</span></button> </li>
              <li class="nav-item"><a class="button button-header" href="" id="navProfileOrLoginButton"></a></li>
            </ul>


          </div>
        </div>
      </nav>
    </div>
  </header>
  <!--================ End Header Menu Area =================-->

  <main class="site-main">

    <!--================ Hero banner start =================-->
    <section class="hero-banner">
      <div class="container">
        <div class="row no-gutters align-items-center pt-60px">
          <div class="col-5 d-none d-sm-block">
            <div class="hero-banner__img">
              <img class="img-fluid" src="img/home/hero-banner.png" alt="">
            </div>
          </div>
          <div class="col-sm-7 col-lg-6 offset-lg-1 pl-4 pl-md-5 pl-lg-0">
            <div class="hero-banner__content">
              <h4>Shop is fun</h4>
              <h1>SP IT</h1>
              <p>At SP IT, We specialise in selling IT products</p>
              <a class="button button-hero" href="/products">Browse Now</a>
            </div>
          </div>
        </div>
      </div>
    </section>


    <!-- ================ trending product section start ================= -->
    <section class="section-margin calc-60px">
      <div class="container">
        <h1>Since 2021</h1>
        <h5>Even though a new company...</h5>
        <p>
          We pride ourselves in delivering top notch and high quality IT products for all customers. We offer the best
          prices among the competitors. If you see any other places with the same price, please contact us. We will be
          happy to match or decrease the price.
        </p>
      </div>
    </section>
    <!-- ================ trending product section end ================= -->

    <!-- ================ trending product section start ================= -->
    <section class="section-margin calc-60px" id="productPreferences">
      <div class="container">
        <h3>Products you might like based on your preferences</h3>
        <div class="row" id="insertProduct">

        </div>
      </div>
    </section>
    <!-- ================ trending product section end ================= -->


    <!--================ Start footer Area  =================-->
    <footer class="footer">
      <div class="footer-area">
        <div class="container">
          <div class="row section_gap">
            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="single-footer-widget tp_widgets">
                <h4 class="footer_title large_title">Our Mission</h4>
                <p>
                  So seed seed green that winged cattle in. Gathering thing made fly you're no
                  divided deep moved us lan Gathering thing us land years living.
                </p>
                <p>
                  So seed seed green that winged cattle in. Gathering thing made fly you're no divided deep moved
                </p>
              </div>
            </div>
            <div class="offset-lg-1 col-lg-2 col-md-6 col-sm-6">
              <div class="single-footer-widget tp_widgets">
                <h4 class="footer_title">Quick Links</h4>
                <ul class="list">
                  <li><a href="#">Home</a></li>
                  <li><a href="#">Shop</a></li>
                  <li><a href="#">Blog</a></li>
                  <li><a href="#">Product</a></li>
                  <li><a href="#">Brand</a></li>
                  <li><a href="#">Contact</a></li>
                </ul>
              </div>
            </div>
            <div class="col-lg-2 col-md-6 col-sm-6">
              <div class="single-footer-widget instafeed">
                <h4 class="footer_title">Gallery</h4>
                <ul class="list instafeed d-flex flex-wrap">
                  <li><img src="img/gallery/r1.jpg" alt=""></li>
                  <li><img src="img/gallery/r2.jpg" alt=""></li>
                  <li><img src="img/gallery/r3.jpg" alt=""></li>
                  <li><img src="img/gallery/r5.jpg" alt=""></li>
                  <li><img src="img/gallery/r7.jpg" alt=""></li>
                  <li><img src="img/gallery/r8.jpg" alt=""></li>
                </ul>
              </div>
            </div>
            <div class="offset-lg-1 col-lg-3 col-md-6 col-sm-6">
              <div class="single-footer-widget tp_widgets">
                <h4 class="footer_title">Contact Us</h4>
                <div class="ml-40">
                  <p class="sm-head">
                    <span class="fa fa-location-arrow"></span>
                    Head Office
                  </p>
                  <p>123, Main Street, Your City</p>

                  <p class="sm-head">
                    <span class="fa fa-phone"></span>
                    Phone Number
                  </p>
                  <p>
                    +123 456 7890 <br>
                    +123 456 7890
                  </p>

                  <p class="sm-head">
                    <span class="fa fa-envelope"></span>
                    Email
                  </p>
                  <p>
                    free@infoexample.com <br>
                    www.infoexample.com
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="footer-bottom">
        <div class="container">
          <div class="row d-flex">
            <p class="col-lg-12 footer-text text-center">
              <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
              Copyright &copy;<script>
                document.write(new Date().getFullYear());
              </script> All rights reserved | This template is made with <i class="fa fa-heart" aria-hidden="true"></i>
              by
              <a href="https://colorlib.com" target="_blank">Colorlib</a>
              <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
            </p>
          </div>
        </div>
      </div>
    </footer>
    <!--================ End footer Area  =================-->



    <script src="vendors/jquery/jquery-3.2.1.min.js"></script>
    <script src="vendors/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="vendors/skrollr.min.js"></script>
    <script src="vendors/owl-carousel/owl.carousel.min.js"></script>
    <script src="vendors/nice-select/jquery.nice-select.min.js"></script>
    <script src="vendors/jquery.ajaxchimp.min.js"></script>
    <script src="vendors/mail-script.js"></script>
    <script src="js/cart_storage.js"></script>
    <script src="js/main.js"></script>

    <script>
      // Init the cart
      getCart();

      $("#productPreferences").hide();

      // Check if user is logged in
      if (!HasTokenExpired(localStorage, "expires")) {
        $("#productPreferences").show();

        fetch(`${BACKEND_URL}/interest`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${localStorage.getItem("token")}`
          }
        })
          .then(res => res.json())
          .then(data => {
            const categoryIds = data.map(d => d.categoryid)
            console.log(categoryIds)


            const productsPromises = categoryIds.map(id => {
              return new Promise((resolve, reject) => {
                fetch(`${BACKEND_URL}/category/${id}/products`)
                  .then(res => res.json())
                  .then(data => {
                    resolve(data)
                  }).catch(e => {
                    reject(e)
                  })
              })
            })

            Promise.all(productsPromises)
              .then(data => {
                let products = [];

                data.forEach(categoryproducts => {
                  categoryproducts.forEach(async product => {
                    products.push(product)
                  })
                })

                console.log(products)
                if (products.length == 0) {
                  $("#insertProduct").html("<h4>No products found</h4>")
                } else {
                  products.forEach(async product => {
                    await insertProduct(product)
                  })
                }

              })

          })
      }

      async function insertProduct(product) {
        console.log("Hello")
        let {
          productid,
          brand,
          categoryname,
          price,
          name
        } = product

        const discount = (await getDiscount(productid))[0]
        let priceTag = `<p class="card-product__price">$${roundToTwo(price)}</p>`
        let promotionTag = ``

        if (discount) {
          promotionTag = `<p class="badge badge-danger">PROMOTION</p>`
          // Strikethrought the original price and put new price
          priceTag =
            `<p class="card-product__price"><s>$${roundToTwo(price)}</s> $${roundToTwo(discount.price)}</p>`
        }



        // Get product images
        fetch(`${BACKEND_URL}/product/${product.productid}/image`)
          .then(response => response.json())
          .then(images => {
            let imageHTML =
              `<img class="card-img" src="https://via.placeholder.com/300" width="100%" alt="">`

            if (images.length > 0) {
              imageHTML = `<img class="card-img" src="${images[0]}" width="100%" height="100%" alt="">`
            }


            const template = `
     <div class="col-md-6 col-lg-4">
                <div class="card text-center card-product">
                  <div class="card-product__img">
                    ${imageHTML}
                  </div>
                  <div class="card-body">
                    ${promotionTag}
                    <p>${categoryname}</p>
                    <h4 class="card-product__title"><a href="/product?productid=${product.productid}">${name}</a></h4>
                    ${priceTag}
                  </div>
                </div>
              </div>  
    `
            $("#insertProduct").append(template)
          })
      }

      async function getDiscount(productid) {
        return new Promise((resolve, reject) => {
          fetch(`${BACKEND_URL}/discount/${productid}`)
            .then(res => {
              if (!res.ok) {
                throw new Error(res.status)
              }

              return res.json();
            }).then(data => {
              let sortedDiscounts = data.sort((a, b) => {
                return a.price - b.price
              })

              resolve(sortedDiscounts);
            }).catch(e => {
              reject(e);
            })
        })
      }
    </script>


</body>

</html>